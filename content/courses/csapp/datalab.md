---
title: data-lab
description: ä¸€ä¸ªåšäº†å¾ˆä¹…ï¼Œåšå®Œä¹‹åå…¶å®è¿˜æŒºæœ‰æ”¶è·çš„å®éªŒï¼ˆæˆ‘æ„¿ç§°ä¹‹ä¸ºæœ€éš¾ğŸ¥ºï¼‰
tags:
  - CMU
  - è®¡ç®—æœºç³»ç»Ÿ
date: 2022-03-29
lastmod: 2024-12-15
draft: false
---

> å‰ç½®æ¡ä»¶ï¼šé˜…è¯»å®Œç¬¬äºŒç« 

# å®éªŒå‡†å¤‡

å®éªŒææ–™ `handout` ä¸‹è½½åœ°å€[CS:APP3e, Bryant and O'Hallaron (cmu.edu)](http://csapp.cs.cmu.edu/3e/labs.html)ã€‚

åªéœ€è¦ä¸‹è½½æ¯ä¸ªå®éªŒä¸­çš„ `Self-Study Handout` å³å¯ï¼Œä¸‹è½½ä¸‹æ¥åæ”¾åˆ°ä¸ `docker` å…±äº«æ–‡ä»¶å¤¹ä¸­ï¼ˆæ–‡ä»¶åç¼€åä¸º `.tar`ï¼‰ï¼Œé˜…è¯» `Writeup` æ–‡ä»¶ï¼Œä½¿ç”¨ `tar xvf datalab-handout.tar.`å‘½ä»¤è§£å‹å³å¯ã€‚

é˜…è¯» `README` æ–‡ä»¶ï¼Œå®Œæˆéœ€è¦çš„æµ‹è¯•:

```bash
make clean
make
```

è¾“å…¥`./btest` å¯ä»¥çœ‹è§ä¸€å †é”™è¯¯ä¿¡æ¯å’Œ $0$ åˆ†æç¤ºï¼Œè¾“å…¥`./btest -g` å¯ä»¥å‘ç°é”™è¯¯ä¿¡æ¯æ¶ˆå¤±äº†ã€‚

è¿™æ ·å°±å¯ä»¥å¼€å§‹å®éªŒäº†ã€‚

æˆ‘ä»¬éœ€è¦å®Œæˆçš„æ–‡ä»¶æ˜¯ `bits.c`ï¼Œå®Œæˆä¸€ä¸ªå‡½æ•°åï¼Œä½¿ç”¨ `make` ç¼–è¯‘ï¼Œå¹¶ç”¨ `./btest` æ¥æŸ¥çœ‹å¾—åˆ†ï¼Œå½“ç„¶ï¼Œåœ¨ `bits.c` ä¸­è¿˜æœ‰æ ¼å¼è¦æ±‚ï¼Œéœ€è¦ä½¿ç”¨ `./dlc bits.c` æ¥æ£€æŸ¥æ ¼å¼é—®é¢˜ã€‚

# å®éªŒè¿‡ç¨‹

## bitXor

è¦æ±‚ä½¿ç”¨ é`~` å’Œ ä¸`&` ç»„åˆå®ç°å¼‚æˆ–`^`ã€‚

å¯ä»¥å‘ç°ï¼š

$$
p \oplus q = p'q + pq' = (p+q)(p'+q') = (p'q')'(pq)'
$$

é‚£ä¹ˆä»£ç å°±å¾ˆç®€å•äº†ï¼š

```c
int bitXor(int x, int y) {
    int res = (~(x & y)) & (~((~x) & (~y)));
    return res;
}
```

## tmin

è¿”å›`int`å‹æ•´æ•°è¡¥ç è¡¨ç¤ºçš„æœ€å°å€¼ã€‚

æˆ‘ä»¬çŸ¥é“ï¼Œæœ€å¤§å€¼æ˜¯ `0x7fffffff` ï¼Œæœ€å°å€¼æ˜¯æœ€å¤§å€¼çš„ç›¸åæ•°-1ï¼Œä¹Ÿå°±æ˜¯ `0x80000000`ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```c
int tmin(void) {
    int res = 1 << 31;
    return res;
}
```

## isTmax

åˆ¤æ–­è¾“å…¥çš„ `x` æ˜¯å¦æ˜¯ `int` æ‰€èƒ½è¡¨ç¤ºçš„æœ€å¤§å€¼ã€‚

è‹¥ `x` æ˜¯æœ€å¤§å€¼ï¼Œé‚£ä¹ˆæ˜¾ç„¶ `x + 1` æ˜¯ä¸Šè¿°çš„ `tmin`ï¼Œè€Œ `~tmin = x`ï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥å¾—åˆ°`tmin^x = 0`ï¼Œä¹Ÿå°±æ˜¯`(~(x + 1))^x = 0`

ç„¶è€Œï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œè‹¥ `-1 = 0xffffffff` ä»£å…¥ä¸Šå¼ä¹Ÿæ˜¯æ»¡è¶³çš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ’é™¤è¿™ç§æƒ…å†µã€‚

ä»£ç å¦‚ä¸‹ï¼š

```c
int isTmax(int x) {
    return !(~(x + 1) ^ x) & !!(x + 1);
}
```

## allOddBits

åˆ¤æ–­æ˜¯å¦æ‰€æœ‰çš„å¥‡æ•°ä½éƒ½ä¸º`1`ã€‚

é¦–å…ˆï¼Œå†™å‡ºå¥‡æ•°ä½å…¨ä¸º `1` ä¸”å…¶ä»–ä½ä¸º `0` çš„æ•°ï¼Œä¸º `0xAAAAAAAA`ã€‚

æˆ‘ä»¬åªéœ€è¦æ„é€ ä¸€ä¸ªæ©ç `flag`ï¼Œä½¿ç”¨æ©ç ä¸ `x` çš„ä¸æ¥å–å‡º `x` çš„å¥‡æ•°ä½ï¼Œè¿›è€Œåˆ¤æ–­å…¶æ˜¯å¦ç¬¦åˆã€‚

æ­£å¸¸æƒ…å†µä¸‹æˆ‘ä»¬åªéœ€è¦åˆ¤æ–­ `(x & 0xAAAAAAA)^0xAAAAAAAA` æ˜¯å¦ç­‰äº `0` å³å¯ï¼›ä½†è¿™æ ·æˆ‘ä»¬æ— æ³•è¿‡æ ¼å¼æµ‹è¯•ï¼Œäºæ˜¯æˆ‘ä»¬éœ€è¦å°†æ©ç  `flag` çš„è®¡ç®—å¤æ‚åŒ–ï¼šå…ˆæ„é€ å‡º `0xAAAA0000` ï¼ŒéšååŠ ä¸Š `0x0000AAAA` å³å¯ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```c
int allOddBits(int x) {
    int flag = 0xAA + (0xAA << 8);
    flag += (flag << 16);
    return !((flag & x) ^ flag);
}
```

## negate

æ±‚å‡º `x` çš„ç›¸åæ•°ã€‚

åº”è¯¥ç®—æ˜¯æœ€ç®€å•çš„ä¸€ä¸ªäº†ï¼Ÿ

```c
int negate(int x) {
    return ~x + 1;
}
```

## isAsciiDigit

åˆ¤æ–­ `x` æ˜¯å¦æ»¡è¶³ $\text{0x30} \le \text{x} \le \text{0x39}$ã€‚

é¦–å…ˆéœ€è¦åˆ¤æ–­ï¼Œ`x` çš„ç¬¬äºŒä¸ªå››ä½æ˜¯å¦ç­‰äº`3`ï¼Œä¸”å‰é¢æ‰€æœ‰ä½æ•°éƒ½ä¸º `0`ï¼Œå¯ä»¥é€šè¿‡ `(x>>4)^3 == 0 ? 1 : 0` æ¥åˆ¤æ–­ã€‚

éšåï¼Œ`x` çš„ç¬¬ä¸€ä¸ªå››ä½éœ€è¦åœ¨ `0` åˆ° `9` ä¹‹é—´ï¼Œé¦–å…ˆï¼Œè‹¥ç¬¬å››ä½ä¸ä¸º `1`ï¼Œé‚£ä¹ˆå¿…ç„¶æ˜¯æ»¡è¶³æ¡ä»¶çš„ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è€ƒè™‘ç¬¬å››ä½ä¸º`1`çš„æƒ…å†µï¼Œé‚£ä¹ˆåªæœ‰ `1001/1000`çš„æƒ…å†µï¼Œå¯ä»¥å‘ç°ä¸­é—´ä¸¤ä½éƒ½ä¸º `0`ï¼Œé‚£ä¹ˆæ’é™¤è¿™ç§æƒ…å†µå°±å¯ä»¥ï¼Œå¯ä»¥é€šè¿‡ `x & 6 == 0 ? 1 : 0` æ¥åˆ¤æ–­ä¸­é—´ä¸¤ä½æ˜¯å¦ä¸º `0`ã€‚

å°†ä¸Šè¿°ä¸¤ç±»åˆ¤æ–­æ¡ä»¶å–æˆ–åä¸ç¬¬ä¸€ç±»å–ä¸ï¼Œå³å¯å¾—åˆ°

ä»£ç å¦‚ä¸‹ï¼š

```c
int isAsciiDigit(int x) {
    return (!((x >> 4) ^ 3)) & ((!((x >> 3) & 1)) | !(x & 6));
}
```

## conditional

å†™ä¸€ä¸ªä¸‰ç›®è¿ç®—ç¬¦

é¦–å…ˆéœ€è¦åˆ¤æ–­`x`çš„çœŸå‡ï¼Œ`K&R C`ä¸­æ˜ç¡®çš„æåˆ°ï¼Œéé›¶å³çœŸã€‚å› æ­¤æˆ‘ä»¬å¯¹ `x` å–ä¸¤æ¬¡é `!!x`ï¼Œå³å¯å¾—åˆ° `0/1`ã€‚

ä¸‰ç›®çš„æ„æ€æ˜¯ï¼Œ`x`ä¸ºçœŸå³è¿”å› `y`ï¼Œå¦åˆ™è¿”å› `z`ã€‚

ä¸å¦¨å‡è®¾ `flag = !!x`ï¼Œç°åœ¨ `flag = 0/1`ï¼Œç”±äºä¸èƒ½ä½¿ç”¨ `if` è¯­å¥ï¼Œå› æ­¤éœ€è¦åœ¨ `return` çš„æ—¶å€™åŒæ—¶è¿”å› `y` å’Œ `z`ï¼Œä½†æ ¹æ® `flag` çš„ä¸åŒï¼Œå°†å…¶ä¸­ä¸€ä¸ªæ•°ç½®ä¸º `0`ã€‚

å‡è®¾`flag = 0`ï¼Œé‚£ä¹ˆåº”è¯¥è¿”å› `z`ï¼Œå°† `y` ç½®ä¸º `0`ã€‚å¯ä»¥å‘ç° `flag & y == 0 | ~flag & z == z`ï¼›å°†`flag = 1` ä»£å…¥æ£€éªŒï¼Œå‘ç°æ— æ³•è¿”å› `y`ã€‚äºæ˜¯æˆ‘ä»¬éœ€è¦å¯¹ `flag` è¿›è¡Œå˜æ¢ï¼Œå½“ `flag = 1` æ—¶ï¼Œå°†å…¶å˜ä¸º `-1`ï¼Œä¹Ÿå°±æ˜¯ `flag = -flag = ~flag + 1`ã€‚è€Œæ˜¾ç„¶è¿™å¯¹ `flag = 0` æ—¶è¿”å›å€¼æ˜¯æ­£ç¡®çš„ã€‚

äºæ˜¯å¯ä»¥å†™å‡ºä»£ç ï¼š

```c
int conditional(int x, int y, int z) {
    int flag = !!x;
    flag = ~flag + 1;
    return (flag & y) | (~flag & z);
}
```

## isLessOrEqual

å®ç°ä¸€ä¸ªå°äºç­‰äºå·ã€‚

å¦‚ä½•å»åˆ¤æ–­ä¸¤ä¸ªæ•°çš„å¤§å°å…³ç³»ï¼Ÿæ— éæ˜¯ï¼Œç¬¦å·ä¸åŒæ­£æ•°å¤§ï¼Œç¬¦å·ç›¸åŒæ¯”è¾ƒå·®å€¼ã€‚

å…ˆåšå·®ï¼Œå¾—åˆ° `y - x`ï¼Œå¹¶å–å‡ºå…¶ç¬¦å·ï¼Œç„¶åå–å‡º `x` çš„ç¬¦å·ä¸ `y` çš„ç¬¦å·ï¼Œå¹¶åšå¼‚æˆ–ï¼Œå³å¯åˆ¤æ–­ `x` ä¸ `y` çš„ç¬¦å·æ˜¯å¦ç›¸åŒï¼Œè‹¥ä¸åŒï¼Œåˆ™åˆ¤æ–­ `x` çš„ç¬¦å·æ˜¯å¦ä¸ºè´Ÿï¼Œå¦åˆ™æ¯”è¾ƒå·®å€¼çš„ç¬¦å·ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```c
int isLessOrEqual(int x, int y) {
    int _x = ~x + 1;
    int sub = y + _x;
    int sub_sign = !(sub >> 31);
    int sign = !((x >> 31) ^ (y >> 31));
    return ((!sign) & (x >> 31)) | (sign & sub_sign);
}
```

## logicalNeg

å®ç°é€»è¾‘çš„é`!`ã€‚

é€»è¾‘éä¹Ÿå°±æ˜¯éé›¶å³ `1`ã€‚å› æ­¤æˆ‘ä»¬åªéœ€è¦åˆ¤æ–­è¾“å…¥çš„ `x` æ˜¯å¦ä¸º `0 `å³å¯ã€‚

åªéœ€è¦åˆ©ç”¨ä¸€ä¸ªç®€å•çš„æ€§è´¨ï¼š`0` çš„ç›¸åæ•°è¿˜æ˜¯ `0`ã€‚æˆ‘ä»¬åªéœ€è¦åˆ¤æ–­ `x` ä¸å®ƒçš„ç›¸åæ•° `-x` å–æˆ–ä¹‹åçš„ç¬¦å·ä½å³å¯ï¼Œè‹¥ä¸º `0`ï¼Œåˆ™ `x` å¿…ä¸º `0`ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```c
int logicalNeg(int x) {
    int _x = ~x + 1;
    return ~((_x | x) >> 31) & 1;
}
```

## howManyBits

æœ€éš¾çš„ä¸€é¢˜äº†å§è¿™åº”è¯¥æ˜¯ï¼Œè¿é¢˜ç›®éƒ½æ²¡çœ‹å§ï¼ˆ

ä¸€ä¸ªæ•°ç”¨è¡¥ç è¡¨ç¤ºæœ€å°‘éœ€è¦å‡ ä½ï¼Ÿ

å¦‚æœæ˜¯ä¸€ä¸ªæ­£æ•°ï¼Œåˆ™éœ€è¦æ‰¾åˆ°å®ƒæœ€é«˜çš„ä¸€ä½æ˜¯`1`çš„ï¼Œå†åŠ ä¸Šç¬¦å·ä½ï¼Œç»“æœä¸º`n + 1`ï¼›å¦‚æœæ˜¯ä¸€ä¸ªè´Ÿæ•°ï¼Œåˆ™éœ€è¦çŸ¥é“å…¶æœ€é«˜çš„ä¸€ä½æ˜¯`0`çš„ã€‚

è¿™é‡Œéœ€è¦ä¸€ä¸ª trickï¼šè‹¥`x`ä¸ºè´Ÿåˆ™æŒ‰ä½å–åï¼Œå¦åˆ™ä¸å˜ã€‚è¿™æ ·å¯ä»¥å¿«é€Ÿæ‰¾åˆ°æœ€é«˜ä½ä¸º 1 çš„ã€‚

ä»é«˜åå…­ä½ï¼Œé«˜å…«ä½ï¼Œé«˜å››ä½ï¼Œé«˜ä¸¤ä½ï¼Œé«˜ä¸€ä½è¿™æ ·é¡ºæ¬¡é€’å‡ï¼Œç¼©å°èŒƒå›´ï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨ `1` ã€‚

emmmmm å…·ä½“çœ‹ä»£ç å§ï¼Œè¿™ä¸ªæ„Ÿè§‰æœ‰äº›åªå¯æ„ä¼šä¸å¯è¨€ä¼ çš„æ„æ€ï¼ŸğŸ˜¶

```c
int howManyBits(int x) {
    int b16, b8, b4, b2, b1, b0;
    int sign = x >> 31;
    x = (sign & ~x) | (~sign & x);
    b16 = !!(x >> 16) << 4;
    x = x >> b16;
    b8 = !!(x >> 8) << 3;
    x = x >> b8;
    b4 = !!(x >> 4) << 2;
    x = x >> b4;
    b2 = !!(x >> 2) << 1;
    x = x >> b2;
    b1 = !!(x >> 1);
    x = x >> b1;
    b0 = x;
    return b16 + b8 + b4 + b2 + b1 + b0 + 1;
}
```

## floatScale2

æ±‚ 2 ä¹˜ä¸€ä¸ªæµ®ç‚¹æ•°çš„å€¼ã€‚

åˆ†ä¸ºè§„æ ¼åŒ–ä¸éè§„æ ¼åŒ–ä¸¤ç±»æ¥è€ƒè™‘ï¼š

é¦–å…ˆæ’é™¤æ— ç©·å°ã€0ã€æ— ç©·å¤§å’Œéæ•°å€¼ NaNï¼Œæ­¤æ—¶æµ®ç‚¹æ•°æŒ‡æ•°éƒ¨åˆ†ï¼ˆ`çœŸæ­£æŒ‡æ•°+bias`ï¼‰åˆ†åˆ«å­˜å‚¨çš„çš„ä¸º 0ï¼Œ0ï¼Œ,255ï¼Œ255ã€‚è¿™äº›æƒ…å†µï¼Œæ— ç©·å¤§å’Œ NaN éƒ½åªéœ€è¦è¿”å›å‚æ•°ï¼ˆ $\infin, NaN$ ï¼‰ï¼Œæ— ç©·å°å’Œ 0 åªéœ€è¦å°†åŸæ•°ä¹˜äºŒå†åŠ ä¸Šç¬¦å·ä½å°±è¡Œäº†ï¼ˆå¹¶ä¸ä¼šè¶Šç•Œ)ã€‚

å‰©ä¸‹çš„æƒ…å†µï¼Œå¦‚æœæŒ‡æ•°+1 ä¹‹åä¸ºæŒ‡æ•°ä¸º 255 åˆ™è¿”å›åŸç¬¦å·æ— ç©·å¤§ï¼Œå¦åˆ™è¿”å›æŒ‡æ•°+1 ä¹‹åçš„åŸç¬¦å·æ•°ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```c
unsigned floatScale2(unsigned uf) {
    int exp = (uf & 0x7f800000) >> 23;
    if (!exp)
        return (uf << 1) | (uf & (1 << 31));
    else if (exp == 255)
        return uf;
    exp++;
    if (exp == 255)
        return 0x7f800000 | (uf & (1 << 31));
    else
        return (exp << 23) | (uf & 0x807fffff);
}
```

## floatFloat2Int

å°†æµ®ç‚¹æ•°è½¬æ¢ä¸ºæ•´æ•°ã€‚

å¯ä»¥å…ˆè®¡ç®—å‡º $E = exp - bias$ã€‚

1. è‹¥ $E<0$ï¼ˆå°æ•°ï¼‰ï¼Œç›´æ¥è¿”å› 0
2. è‹¥ $E\ge 31$ï¼Œåˆ™è¿”å›è§„å®šçš„æº¢å‡ºå€¼ `0x80000000u`
3. å¯¹äºè§„æ ¼åŒ–çš„æ•°ï¼Œè¿›è¡Œæ­£å¸¸å¤„ç†ï¼Œé€šè¿‡å…¬å¼ $V = (-1)^s\times M \times 2^E$ï¼Œå…ˆç»™ä½æ•°è¡¥å……ä¸Šçœç•¥çš„ `1`ï¼Œåˆ¤æ–­ `E` æ˜¯å¦å°äº 23ï¼Œè‹¥å°äº 23 åˆ™éœ€è¦èˆå» `23-E `ä½ã€‚è¿”å›æ—¶æ ¹æ®ç¬¦å·ä½è¿”å›å³å¯ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```c
int floatFloat2Int(unsigned uf) {
    int exp = ((uf >> 23) & 0xff) - 127;
    if (exp >= 31)return 0x80000000u;
    else if (exp < 0)return 0;
    else {
        int sign = (uf >> 31) & 1;
        int frac = (uf & 0x7fffff) | (1 << 23);
        if (exp < 23) {
            if (sign)return -(frac >> (23 - exp));
            else return frac >> (23 - exp);
        }
        else {
            if (sign)return -frac >> (exp - 23);
            else return frac >> (exp - 23);
        }
    }
}
```

## floatPower2

æ±‚ $2.0^x$

å…ˆç®—å‡ºåç§»åçš„æŒ‡æ•° `e`ï¼Œåˆ¤æ–­ `e` ä¸ 0/255 çš„å¤§å°å…³ç³»ï¼Œæ ¹æ®é¢˜ç›®æè¿°è¿”å›å¯¹åº”çš„å€¼ã€‚å¦åˆ™è¿”å›æ­£å¸¸æµ®ç‚¹å€¼å³å¯ï¼Œ`frac` éƒ¨åˆ†ä¸º 0ï¼Œè¿”å› `e<<23`å³å¯ã€‚

```c
unsigned floatPower2(int x) {
    int inf = 0xff << 23;
    int exp = 127 + x;
    if (exp <= 0) return 0;
    if (exp >= 255) return inf;
    return exp << 23;
}
```
